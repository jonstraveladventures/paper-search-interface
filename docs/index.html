<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Paper Search Interface (Static)</title>
  <style>
    * { box-sizing: border-box; }
    body { font-family: Arial, sans-serif; margin: 0; padding: 20px; background: #f5f5f5; }
    .container { max-width: 1400px; margin: 0 auto; background: white; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); overflow: hidden; }
    .header { background: #2c3e50; color: white; padding: 20px; text-align: center; }
    .search-panel { padding: 20px; border-bottom: 1px solid #eee; background: #f8f9fa; }
    .search-row { display: flex; gap: 20px; margin-bottom: 15px; align-items: center; flex-wrap: wrap; }
    .search-group { flex: 1; min-width: 220px; }
    .search-group label { display: block; margin-bottom: 5px; font-weight: bold; color: #333; }
    .search-group input, .search-group select { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; }
    .year-range { display: flex; gap: 10px; align-items: center; flex-direction: column; }
    /* Dual-handle year slider */
    .dual-slider { position: relative; height: 48px; width: 50%; }
    .dual-slider input[type="range"] {
      position: absolute; left: 0; right: 0; width: 100%;
      margin: 0; padding: 0; background: transparent; pointer-events: none;
      -webkit-appearance: none; height: 48px;
    }
    .dual-slider input[type="range"]::-webkit-slider-runnable-track { height: 10px; background: #d0d7de; border-radius: 6px; cursor: pointer; }
    .dual-slider input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none; pointer-events: auto; width: 22px; height: 22px;
      border-radius: 50%; background: #3498db; border: 2px solid #fff; box-shadow: 0 0 0 2px #3498db; margin-top: -6px;
    }
    .dual-slider input[type="range"]::-moz-range-track { height: 10px; background: #d0d7de; border-radius: 6px; }
    .dual-slider input[type="range"]::-moz-range-thumb { width: 22px; height: 22px; border-radius: 50%; background: #3498db; border: 2px solid #fff; box-shadow: 0 0 0 2px #3498db; pointer-events: auto; }
    .filter-section { margin-bottom: 20px; }
    .filter-section h3 { margin: 0 0 10px 0; color: #2c3e50; font-size: 16px; }
    .countries-container, .venues-container { max-height: 260px; overflow-y: auto; border: 1px solid #ddd; border-radius: 4px; padding: 10px; background: white; }
    .continent-group { margin-bottom: 15px; }
    .continent-header, .subfield-header { background: #e9ecef; padding: 8px; margin: 0 0 10px 0; font-weight: bold; user-select: none; display: flex; align-items: center; justify-content: space-between; border-radius: 4px; }
    .continent-countries, .subfield-venues { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 8px; margin-left: 0; padding-top: 8px; }
    .continent-countries.collapsed, .subfield-venues.collapsed { display: none; }
    .country-item, .venue-item { display: flex; align-items: center; gap: 8px; margin-bottom: 0; background: #fff; border: 1px solid #e6e6e6; padding: 6px 10px; border-radius: 6px; }
    .country-item label, .venue-item label { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .selection-buttons { margin-bottom: 10px; display: flex; gap: 10px; flex-wrap: wrap; }
    .selection-button { background: #6c757d; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 12px; }
    .selection-button.primary { background: #007bff; }
    .search-button { background: #3498db; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; font-size: 16px; }
    .clear-button { background: #95a5a6; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; font-size: 16px; margin-left: 10px; }
    .results-panel { padding: 20px; }
    .map-panel { padding: 20px; padding-top: 0; }
    #map-wrapper { width: 100%; height: 520px; background: #fff; border: 1px solid #ddd; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.06); display: none; overflow: hidden; }
    .map-controls { display: none; margin: 8px 0 16px 0; }
    .bubble-toggle { display: inline-flex; align-items: center; gap: 6px; margin-left: 10px; font-size: 12px; }
    .results-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    .results-actions { display: flex; gap: 10px; }
    .export-button { background: #27ae60; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-size: 14px; transition: background-color 0.2s; }
    .results-count { font-size: 18px; font-weight: bold; color: #2c3e50; }
    .paper-item { border: 1px solid #ddd; border-radius: 4px; padding: 15px; margin-bottom: 15px; background: white; }
    .paper-title { font-size: 16px; font-weight: bold; color: #2c3e50; margin-bottom: 8px; }
    .paper-authors { color: #666; margin-bottom: 8px; }
    .paper-meta { display: flex; gap: 20px; font-size: 12px; color: #888; flex-wrap: wrap; }
    .paper-meta span { background: #f8f9fa; padding: 2px 8px; border-radius: 12px; }
    .loading { text-align: center; padding: 20px; color: #666; }
    .no-results { text-align: center; padding: 40px; color: #666; font-style: italic; }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div style="display:flex;justify-content:space-between;align-items:center;">
        <h1 style="margin:0;">Paper Search Interface</h1>
        <a href="https://github.com/jonstraveladventures/paper-search-interface" target="_blank" style="color:#fff;text-decoration:underline;">View on GitHub</a>
      </div>
      <p id="paper-count">Loading data...</p>
      <p style="font-size: 12px; margin-top: 10px; opacity: 0.8;">
        Data sourced from <a href="https://papercopilot.com" target="_blank" style="color: white; text-decoration: underline;">Paper Copilot</a>
      </p>
    </div>

    <div class="search-panel">
      <div class="search-row">
        <div class="search-group">
          <label for="title-search">Title Search:</label>
          <input type="text" id="title-search" placeholder="Enter title keywords..." />
        </div>
        <div class="search-group">
          <label for="author-search">Author Search:</label>
          <input type="text" id="author-search" placeholder="Enter author name..." />
        </div>
        <div class="search-group">
          <label for="institution-search">Institution Search:</label>
          <input type="text" id="institution-search" placeholder="Enter institution name..." />
        </div>
      </div>

      <div class="search-row">
        <div class="search-group">
          <label>Year Range:</label>
          <div class="year-range">
            <div class="dual-slider">
              <input type="range" id="year-range-min" min="" max="" value="" oninput="syncYearRangeFromSlider()" />
              <input type="range" id="year-range-max" min="" max="" value="" oninput="syncYearRangeFromSlider()" />
            </div>
            <div id="year-range-display" style="font-size:14px;color:#444;">Years: </div>
            <div style="display:none;">
              <input type="number" id="year-min" placeholder="Min" />
              <input type="number" id="year-max" placeholder="Max" />
            </div>
          </div>
        </div>
      </div>

      <div class="search-row">
        <div class="search-group">
          <button class="search-button" onclick="searchPapers()">Search Papers</button>
          <button class="clear-button" onclick="clearFilters()">Clear Filters</button>
          <button class="clear-button" id="show-map-btn" onclick="toggleMapButton()">Show map</button>
        </div>
      </div>

      <div class="filter-section">
        <h3>Countries</h3>
        <div class="selection-buttons">
          <button class="selection-button primary" onclick="selectAllCountries()">Select All Countries</button>
          <button class="selection-button" onclick="clearAllCountries()">Clear All Countries</button>
        </div>
        <div class="countries-container" id="countries-container"></div>
      </div>

      <div class="filter-section">
        <div style="background: #f8f9fa; padding: 10px; border-radius: 4px; margin-bottom: 10px;">
          <label style="display: flex; align-items: center; gap: 8px; font-weight: bold; color: #495057;">
            <input type="checkbox" id="include-unknown" onchange="updateIncludeUnknown()" />
            Include papers with no country data
          </label>
          <div style="font-size: 12px; color: #6c757d; margin-top: 6px;">
            Note: Some conferences have no country data included, so their papers will be excluded unless this is ticked.
          </div>
        </div>
      </div>

      <div class="filter-section">
        <div style="background: #f8f9fa; padding: 10px; border-radius: 4px; margin-bottom: 10px;">
          <label style="display: flex; align-items: center; gap: 8px; font-weight: bold; color: #495057;">
            <input type="checkbox" id="include-rejected" onchange="updateIncludeRejected()" />
            Include rejected/withdrawn papers
          </label>
        </div>
      </div>

      <div class="filter-section">
        <h3>Venues</h3>
        <div class="selection-buttons">
          <button class="selection-button primary" onclick="selectAllVenues()">Select All Venues</button>
          <button class="selection-button" onclick="clearAllVenues()">Clear All Venues</button>
        </div>
        <div class="venues-container" id="venues-container"></div>
      </div>
    </div>

    <div class="results-panel">
      <div class="map-panel">
        <div id="map-wrapper"></div>
        <div class="map-controls">
          <button class="export-button" onclick="downloadInlineMapPNG()">Download map (PNG)</button>
          <label class="bubble-toggle"><input type="checkbox" id="toggle-bubbles" onchange="renderInlineMap()"/> Show bubbles</label>
        </div>
      </div>
      <div class="results-header">
        <div class="results-count">Results: <span id="results-count">0</span> papers</div>
        <div class="results-actions">
          <button id="export-btn" class="export-button" onclick="exportToCSV()" style="display: none;">📥 Export to CSV</button>
        </div>
      </div>
      <div id="results-container">
        <div class="no-results">Enter search criteria and click "Search Papers" to begin</div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
  <script src="https://cdn.jsdelivr.net/npm/topojson-client@3"></script>
  <script>
    // Static data loaded from docs/data.json
    let allPapers = [];
    let selectedCountries = [];
    let selectedVenues = [];
    let includeUnknown = false;
    let includeRejected = false;
    let showMap = false;
    let cachedTopo = null;

    const CONTINENTS = {
      'Africa': ['Algeria','Angola','Benin','Botswana','Burkina Faso','Burundi','Cameroon','Cape Verde','Central African Republic','Chad','Comoros','Congo','Democratic Republic of the Congo','Djibouti','Egypt','Equatorial Guinea','Eritrea','Eswatini','Ethiopia','Gabon','Gambia','Ghana','Guinea','Guinea-Bissau','Ivory Coast','Kenya','Lesotho','Liberia','Libya','Madagascar','Malawi','Mali','Mauritania','Mauritius','Morocco','Mozambique','Namibia','Niger','Nigeria','Rwanda','São Tomé and Príncipe','Senegal','Seychelles','Sierra Leone','Somalia','South Africa','South Sudan','Sudan','Tanzania','Togo','Tunisia','Uganda','Zambia','Zimbabwe'],
      'Asia': ['Afghanistan','Armenia','Azerbaijan','Bahrain','Bangladesh','Bhutan','Brunei Darussalam','Cambodia','China','Cyprus','Georgia','India','Indonesia','Iran','Iraq','Israel','Japan','Jordan','Kazakhstan','Kuwait','Kyrgyzstan','Laos','Lebanon','Malaysia','Maldives','Mongolia','Myanmar','Nepal','North Korea','Oman','Pakistan','Palestine','Philippines','Qatar','Saudi Arabia','Singapore','South Korea','Sri Lanka','Syria','Taiwan','Tajikistan','Thailand','Timor-Leste','Turkey','Turkmenistan','United Arab Emirates','Uzbekistan','Vietnam','Yemen'],
      'Europe': ['Albania','Andorra','Austria','Belarus','Belgium','Bosnia and Herzegovina','Bulgaria','Croatia','Czech Republic','Czechia','Denmark','Estonia','Finland','France','Germany','Gibraltar','Greece','Hungary','Iceland','Ireland','Italy','Kosovo','Latvia','Liechtenstein','Lithuania','Luxembourg','Malta','Moldova','Monaco','Montenegro','Netherlands','North Macedonia','Norway','Poland','Portugal','Romania','Russia','Russian Federation','San Marino','Serbia','Slovakia','Slovenia','Spain','Sweden','Switzerland','Ukraine','United Kingdom','Vatican City'],
      'North America': ['Antigua and Barbuda','Bahamas','Barbados','Belize','Canada','Costa Rica','Cuba','Dominica','Dominican Republic','El Salvador','Grenada','Guatemala','Haiti','Honduras','Jamaica','Mexico','Nicaragua','Panama','Puerto Rico','Saint Kitts and Nevis','Saint Lucia','Saint Vincent and the Grenadines','Trinidad and Tobago','United States'],
      'South America': ['Argentina','Bolivia','Brazil','Chile','Colombia','Ecuador','Guyana','Paraguay','Peru','Suriname','Uruguay','Venezuela'],
      'Oceania': ['Australia','Fiji','French Polynesia','Kiribati','Marshall Islands','Micronesia','Nauru','New Caledonia','New Zealand','Palau','Papua New Guinea','Samoa','Solomon Islands','Tonga','Tuvalu','Vanuatu']
    };

    function getUnique(arr) { return Array.from(new Set(arr)); }

    function makeIdSafe(text) {
      return String(text || '')
        .toLowerCase()
        .replace(/[^a-z0-9]+/g, '-')
        .replace(/^-+|-+$/g, '');
    }

    function renderCountries() {
      const countriesContainer = document.getElementById('countries-container');
      countriesContainer.innerHTML = '';
      Object.entries(CONTINENTS).forEach(([continent, countries]) => {
        const continentSlug = makeIdSafe(continent);
        const group = document.createElement('div');
        group.className = 'continent-group';
        group.innerHTML = `
          <div class="continent-header">
            <span style="flex-grow:1;">${continent} (${countries.length} countries)</span>
            <button class="selection-button" onclick="selectContinentCountries('${continent}')">Select All ${continent}</button>
          </div>
          <div class="continent-countries" id="continent-${continentSlug}"></div>
        `;
        countriesContainer.appendChild(group);
        const list = group.querySelector(`#continent-${continentSlug}`);
        countries.forEach(country => {
          const countryId = makeIdSafe(country);
          const item = document.createElement('div');
          item.className = 'country-item';
          item.innerHTML = `<input type="checkbox" id="country-${countryId}" value="${country}" onchange="updateSelectedCountries()"/> <label for="country-${countryId}">${country}</label>`;
          list.appendChild(item);
        });
      });
    }

    function initFilters() {
      const yearValues = allPapers.map(p => p.Year).filter(v => typeof v === 'number');
      const yearMin = Math.min(...yearValues);
      const yearMax = Math.max(...yearValues);
      const numMin = document.getElementById('year-min');
      const numMax = document.getElementById('year-max');
      const rMin = document.getElementById('year-range-min');
      const rMax = document.getElementById('year-range-max');
      if (numMin) numMin.value = yearMin;
      if (numMax) numMax.value = yearMax;
      if (rMin && rMax) {
        rMin.min = yearMin; rMin.max = yearMax; rMin.value = yearMin;
        rMax.min = yearMin; rMax.max = yearMax; rMax.value = yearMax;
      }
      updateYearRangeDisplay();

      // Venues grouped by subfield using existing Subfield field
      const venuesBySubfield = {};
      allPapers.forEach(p => {
        const sub = p.Subfield || 'Other';
        const conf = p.Conference || 'Unknown';
        if (!venuesBySubfield[sub]) venuesBySubfield[sub] = new Set();
        venuesBySubfield[sub].add(conf);
      });
      const venuesContainer = document.getElementById('venues-container');
      // Clear any placeholder like "Loading venues..." before populating
      venuesContainer.innerHTML = '';
      Object.entries(venuesBySubfield).forEach(([subfield, set]) => {
        const subSlug = makeIdSafe(subfield);
        const group = document.createElement('div');
        group.className = 'subfield-group';
        group.innerHTML = `
          <div class="subfield-header">
            <span style="flex-grow:1;">${subfield} (${set.size} venues)</span>
            <button class="selection-button" onclick="selectSubfieldVenues('${subfield}')">Select All ${subfield}</button>
          </div>
          <div class="subfield-venues" id="subfield-${subSlug}"></div>
        `;
        venuesContainer.appendChild(group);
        const list = group.querySelector(`#subfield-${subSlug}`);
        Array.from(set).sort().forEach(venue => {
          const venueId = makeIdSafe(venue);
          const item = document.createElement('div');
          item.className = 'venue-item';
          item.innerHTML = `<input type="checkbox" id="venue-${venueId}" value="${venue}" onchange="updateSelectedVenues()"/> <label for="venue-${venueId}">${venue}</label>`;
          list.appendChild(item);
        });
      });

      document.getElementById('paper-count').textContent = `Loaded ${allPapers.length.toLocaleString()} papers`;
    }

    function updateSelectedCountries() {
      selectedCountries = Array.from(document.querySelectorAll('input[id^="country-"]:checked')).map(c => c.value);
    }
    function updateSelectedVenues() {
      selectedVenues = Array.from(document.querySelectorAll('input[id^="venue-"]:checked')).map(c => c.value);
    }
    function updateIncludeUnknown() { includeUnknown = document.getElementById('include-unknown').checked; }
    function updateIncludeRejected() { includeRejected = document.getElementById('include-rejected').checked; }

    function selectAllCountries() { document.querySelectorAll('input[id^="country-"]').forEach(cb => cb.checked = true); updateSelectedCountries(); }
    function clearAllCountries() { document.querySelectorAll('input[id^="country-"]').forEach(cb => cb.checked = false); updateSelectedCountries(); }
    function selectAfricanCountries() {
      clearAllCountries();
      const allowed = new Set(CONTINENTS['Africa']);
      document.querySelectorAll('input[id^="country-"]').forEach(cb => { cb.checked = allowed.has(cb.value); });
      updateSelectedCountries();
    }
    function selectContinentCountries(continent) {
      const slug = makeIdSafe(continent);
      document.querySelectorAll(`#continent-${slug} input[type="checkbox"]`).forEach(cb => cb.checked = true);
      updateSelectedCountries();
    }
    function selectAllVenues() { document.querySelectorAll('input[id^="venue-"]').forEach(cb => cb.checked = true); updateSelectedVenues(); }
    function clearAllVenues() { document.querySelectorAll('input[id^="venue-"]').forEach(cb => cb.checked = false); updateSelectedVenues(); }
    function selectSubfieldVenues(subfield) {
      const slug = makeIdSafe(subfield);
      document.querySelectorAll(`#subfield-${slug} input[type="checkbox"]`).forEach(cb => cb.checked = true);
      updateSelectedVenues();
    }

    function clearFilters() {
      document.getElementById('title-search').value = '';
      document.getElementById('author-search').value = '';
      const inst = document.getElementById('institution-search'); if (inst) inst.value = '';
      const years = allPapers.map(p => p.Year).filter(v => typeof v === 'number');
      const ymin = Math.min(...years), ymax = Math.max(...years);
      document.getElementById('year-min').value = ymin;
      document.getElementById('year-max').value = ymax;
      const rMin = document.getElementById('year-range-min');
      const rMax = document.getElementById('year-range-max');
      if (rMin && rMax) { rMin.value = ymin; rMax.value = ymax; updateYearRangeDisplay(); }
      document.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
      selectedCountries = []; selectedVenues = []; includeUnknown = false; includeRejected = false;
      document.getElementById('results-container').innerHTML = '<div class="no-results">Enter search criteria and click "Search Papers" to begin</div>';
      document.getElementById('results-count').textContent = '0';
      document.getElementById('export-btn').style.display = 'none';
      // hide map
      showMap = false;
      const wrapper = document.getElementById('map-wrapper');
      const controls = document.querySelector('.map-controls');
      wrapper.style.display = 'none';
      controls.style.display = 'none';
      wrapper.innerHTML = '';
    }

    function filterPapers() {
      const titleSearch = (document.getElementById('title-search').value || '').toLowerCase();
      const authorSearch = (document.getElementById('author-search').value || '').toLowerCase();
      const institutionSearch = (document.getElementById('institution-search') ? document.getElementById('institution-search').value.toLowerCase() : '');
      const yearMin = parseInt(document.getElementById('year-min').value, 10);
      const yearMax = parseInt(document.getElementById('year-max').value, 10);

      return allPapers.filter(row => {
        // Title/author
        if (titleSearch && !(row.Title || '').toLowerCase().includes(titleSearch)) return false;
        if (authorSearch && !(row.Authors || '').toLowerCase().includes(authorSearch)) return false;
        if (institutionSearch && !(row.Author_Institutions || '').toLowerCase().includes(institutionSearch)) return false;

        // Year range
        if (Number.isFinite(yearMin) && typeof row.Year === 'number' && row.Year < yearMin) return false;
        if (Number.isFinite(yearMax) && typeof row.Year === 'number' && row.Year > yearMax) return false;

        // Countries
        if (selectedCountries.length > 0) {
          const countriesStr = row.Author_Countries || '';
          if (!countriesStr.trim()) return includeUnknown; // only include if explicitly requested
          const countries = countriesStr.split(',').map(c => c.trim()).filter(Boolean);
          const hasMatch = countries.some(country => {
            if (selectedCountries.includes(country)) return true;
            if (country === 'Kingdom of Saudi Arabia' && selectedCountries.includes('Saudi Arabia')) return true;
            if (country === 'State of Palestine' && selectedCountries.includes('Palestine')) return true;
            if (country === 'Türkiye' && selectedCountries.includes('Turkey')) return true;
            return false;
          });
          if (!hasMatch) return false;
        } else {
          if (!includeUnknown && !(row.Author_Countries || '').trim()) return false;
        }

        // Venues
        if (selectedVenues.length > 0 && row.Conference) {
          if (!selectedVenues.includes(row.Conference)) return false;
        }

        // Status (exclude rejected unless included)
        if (!includeRejected) {
          const s = (row.Status || '').toLowerCase();
          if (s.includes('reject') || s.includes('withdraw')) return false;
        }

        return true;
      });
    }

    function updateYearRangeDisplay() {
      const yrMin = document.getElementById('year-range-min');
      const yrMax = document.getElementById('year-range-max');
      const numMin = document.getElementById('year-min');
      const numMax = document.getElementById('year-max');
      if (!yrMin || !yrMax) return;
      let a = parseInt(yrMin.value, 10);
      let b = parseInt(yrMax.value, 10);
      if (isFinite(a) && isFinite(b) && a > b) { const t = a; a = b; b = t; }
      if (numMin && numMax) { numMin.value = a; numMax.value = b; }
      const disp = document.getElementById('year-range-display');
      if (disp) disp.textContent = `Years: ${a} – ${b}`;
    }

    function syncYearRangeFromSlider() { updateYearRangeDisplay(); }

    function searchPapers() {
      const container = document.getElementById('results-container');
      container.innerHTML = '<div class="loading">Searching...</div>';

      const filtered = filterPapers();
      const totalCount = filtered.length;
      const maxResults = 1000;
      const displayedList = totalCount > maxResults ? filtered.slice(0, maxResults) : filtered;

      let html = '';
      if (totalCount === 0) {
        html = '<div class="no-results">No papers found matching your criteria</div>';
      } else {
        if (totalCount > maxResults) {
          html += `<div style="background:#fff3cd;border:1px solid #ffeaa7;padding:10px;margin-bottom:15px;border-radius:4px;color:#856404;">⚠️ Showing first ${displayedList.length} results out of ${totalCount} total. Use more specific filters to narrow down your search, or export to CSV to get all results.</div>`;
        }
        displayedList.forEach(row => {
          const status = row.Status || 'Unknown';
          html += `
            <div class="paper-item">
              <div class="paper-title">${row.Title}</div>
              <div class="paper-authors">${row.Authors}</div>
              <div class="paper-meta">
                <span>${row.Conference || ''} ${row.Year || ''}</span>
                <span>${row.Subfield || ''}</span>
                <span>${status}</span>
                <span>${row.Track || 'N/A'}</span>
                <span>${Number.isFinite(row.Citations) ? row.Citations : 0} citations</span>
                <span>${row.Author_Countries || 'N/A'}</span>
              </div>
            </div>`;
        });
      }

      container.innerHTML = html;
      document.getElementById('results-count').textContent = `${totalCount}` + (totalCount > maxResults ? ` (showing first ${maxResults})` : '');
      document.getElementById('export-btn').style.display = totalCount > 0 ? 'inline-block' : 'none';
      if (showMap) { renderInlineMap(); }
    }

    function exportToCSV() {
      const filtered = filterPapers();
      if (filtered.length === 0) return;
      const header = Object.keys(filtered[0]);
      const rows = [header.join(',')].concat(
        filtered.map(obj => header.map(k => JSON.stringify(obj[k] != null ? obj[k] : "")).join(','))
      );
      const csv = rows.join('\n');
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'search_results.csv';
      a.click();
      URL.revokeObjectURL(url);
    }

    // Render countries immediately (no data required)
    renderCountries();

    // Show loading placeholder for venues
    document.getElementById('venues-container').innerHTML = '<div class="loading">Loading venues...</div>';

    // Load data.json and then initialize data-dependent UI
    fetch('data.json', { cache: 'no-store' })
      .then(r => r.json())
      .then(data => { allPapers = data; initFilters(); })
      .catch(err => {
        document.getElementById('paper-count').textContent = 'Failed to load data.json';
        console.error(err);
      });

    // Enter key triggers search
    document.addEventListener('keypress', e => { if (e.key === 'Enter') searchPapers(); });

    function toggleMapButton() {
      showMap = !showMap;
      const wrapper = document.getElementById('map-wrapper');
      const controls = document.querySelector('.map-controls');
      const btn = document.getElementById('show-map-btn');
      if (showMap) {
        wrapper.style.display = 'block';
        controls.style.display = 'block';
        btn.textContent = 'Hide map';
        renderInlineMap();
      } else {
        wrapper.style.display = 'none';
        controls.style.display = 'none';
        wrapper.innerHTML = '';
        btn.textContent = 'Show map';
      }
    }

    function aggregateCounts(filtered) {
      const counts = new Map();
      const selectedSet = new Set(selectedCountries || []);
      filtered.forEach(row => {
        const s = (row.Author_Countries || '').trim();
        if (!s) return;
        s.split(',').map(c => c.trim()).filter(Boolean).forEach(country => {
          if (selectedSet.size === 0 || selectedSet.has(country)) {
            counts.set(country, (counts.get(country) || 0) + 1);
          }
        });
      });
      return counts;
    }

    function aggregateAuthorCounts(filtered) {
      const authorsByCountry = new Map();
      const selectedSet = new Set(selectedCountries || []);
      filtered.forEach(row => {
        const countriesStr = (row.Author_Countries || '').trim();
        if (!countriesStr) return;
        const countries = countriesStr.split(',').map(c => c.trim()).filter(Boolean);
        const authors = (row.Authors || '').split(',').map(a => a.trim()).filter(Boolean);
        countries.forEach(country => {
          if (selectedSet.size > 0 && !selectedSet.has(country)) return;
          if (!authorsByCountry.has(country)) authorsByCountry.set(country, new Set());
          const set = authorsByCountry.get(country);
          authors.forEach(a => set.add(a));
        });
      });
      const counts = new Map();
      authorsByCountry.forEach((set, country) => counts.set(country, set.size));
      return counts;
    }

    function buildBubblePoints(filtered, alias) {
      const papersBy = new Map();
      const authorsBy = new Map();
      const venuesBy = new Map();
      const selectedSet = new Set(selectedCountries || []);
      filtered.forEach(row => {
        const countriesStr = (row.Author_Countries || '').trim();
        if (!countriesStr) return;
        const venue = row.Conference || '';
        const authors = (row.Authors || '').split(',').map(a => a.trim()).filter(Boolean);
        countriesStr.split(',').map(c => c.trim()).filter(Boolean).forEach(country0 => {
          const country = alias.get(country0) || country0;
          if (selectedSet.size > 0 && !selectedSet.has(country0)) return;
          papersBy.set(country, (papersBy.get(country) || 0) + 1);
          if (!authorsBy.has(country)) authorsBy.set(country, new Set());
          const aset = authorsBy.get(country); authors.forEach(a => aset.add(a));
          if (!venuesBy.has(country)) venuesBy.set(country, new Map());
          if (venue) venuesBy.get(country).set(venue, (venuesBy.get(country).get(venue) || 0) + 1);
        });
      });
      const points = [];
      papersBy.forEach((pcount, country) => {
        const vmap = venuesBy.get(country) || new Map();
        const top = Array.from(vmap.entries()).sort((a,b)=>b[1]-a[1]).slice(0,3).map(([venue,count])=>({venue, count}));
        points.push({ location: country, papers: pcount, researchers: (authorsBy.get(country)||new Set()).size, top_venues: top });
      });
      return points;
    }

    async function renderInlineMap() {
      const wrapper = document.getElementById('map-wrapper');
      if (!showMap) return;
      // Use current filtered data
      const filtered = filterPapers();
      const rawCounts = aggregateCounts(filtered);
      const authorCounts = aggregateAuthorCounts(filtered);
      // alias to atlas names
      const alias = new Map([
        ['United States', 'United States of America'],
        ['Russian Federation', 'Russia'],
        ['Russia', 'Russian Federation'],
        ['Czechia', 'Czech Republic'],
        ['Türkiye', 'Turkey'],
        ['Kingdom of Saudi Arabia', 'Saudi Arabia'],
        ['State of Palestine', 'Palestine'],
        ["Ivory Coast", "Côte d'Ivoire"],
        ['Democratic Republic of the Congo', 'Democratic Republic of the Congo'],
      ]);
      const nameToValue = new Map();
      rawCounts.forEach((v, k) => {
        const tgt = alias.get(k) || k; nameToValue.set(tgt, (nameToValue.get(tgt) || 0) + v);
      });

      if (!cachedTopo) { cachedTopo = await fetch('https://cdn.jsdelivr.net/npm/world-atlas@2/countries-110m.json').then(r => r.json()); }
      const countries = topojson.feature(cachedTopo, cachedTopo.objects.countries).features;

      const width = wrapper.clientWidth || 1000;
      const height = wrapper.clientHeight || 520;
      wrapper.innerHTML = '';
      const svg = d3.select(wrapper).append('svg').attr('viewBox', `0 0 ${width} ${height}`);
      const projection = d3.geoNaturalEarth1().fitSize([width, height], {type: 'Sphere'});
      const path = d3.geoPath(projection);
      const nonZeroMax = Math.max(1, d3.max(Array.from(nameToValue.values()).filter(v => v > 0)) || 1);
      const color = d3.scaleSequentialSqrt([1, nonZeroMax], d3.interpolateYlGnBu);

      svg.append('path').attr('fill', '#eef6fb').attr('d', path({type: 'Sphere'}));
      svg.append('g')
        .selectAll('path')
        .data(countries)
        .join('path')
        .attr('d', path)
        .attr('fill', d => { const v = nameToValue.get(d.properties.name) || 0; return v>0 ? color(v) : '#f0f0f0'; })
        .attr('stroke', '#555')
        .attr('stroke-width', 0.4)
        .append('title')
        .text(d => {
          const papers = (nameToValue.get(d.properties.name) || 0).toLocaleString();
          const authors = (authorCounts.get(d.properties.name) || 0).toLocaleString();
          return `${d.properties.name}: ${papers} papers; ${authors} unique authors`;
        });

      // Legend
      const legend = svg.append('g').attr('class','legend').attr('transform', `translate(20,${height-30})`);
      const stops = d3.range(0,1.01,0.1);
      legend.selectAll('rect').data(stops).join('rect')
        .attr('x',(d,i)=>i*20).attr('y',0).attr('width',20).attr('height',10)
        .attr('fill', d => d===0 ? '#f0f0f0' : color(d*nonZeroMax));
      legend.append('text').attr('x',0).attr('y',24).text('0');
      legend.append('text').attr('x',200).attr('y',24).attr('text-anchor','end').text(d3.format(',')(nonZeroMax));
      legend.append('text').attr('x',0).attr('y',-6).text('Papers');

      // Optional bubbles overlay from client-side data
      const showBubbles = document.getElementById('toggle-bubbles') && document.getElementById('toggle-bubbles').checked;
      if (showBubbles) {
        const points = buildBubblePoints(filtered, alias);
        const countryByName = new Map(countries.map(f => [f.properties.name, f]));
        const rScale = d3.scaleSqrt().domain([1, d3.max(points, d => d.papers) || 1]).range([2, 18]);
        const bubbles = svg.append('g').attr('class','bubbles');
        const tip = d3.select(wrapper).append('div').attr('class','tooltip').style('position','absolute').style('pointer-events','none').style('background','#fff').style('border','1px solid #ccc').style('padding','6px 8px').style('border-radius','4px').style('font-size','12px').style('display','none');
        bubbles.selectAll('circle')
          .data(points)
          .join('circle')
          .attr('fill','rgba(231,76,60,0.65)')
          .attr('stroke','#c0392b')
          .attr('stroke-width',0.8)
          .attr('r', d => rScale(Math.max(1, d.papers)))
          .attr('transform', d => {
            const feature = countryByName.get(d.location) || countryByName.get(alias.get(d.location) || '');
            if (!feature) return '';
            const [cx, cy] = d3.geoPath(projection).centroid(feature);
            return `translate(${cx},${cy})`;
          })
          .on('mousemove', (event, d) => {
            const venues = (d.top_venues || []).map(v => `${v.venue} (${v.count})`).join(', ');
            tip.style('display','block')
               .style('left', (event.offsetX + 12) + 'px')
               .style('top', (event.offsetY + 12) + 'px')
               .html(`<strong>${d.location}</strong><br/>Papers: ${d.papers.toLocaleString()}<br/>Researchers: ${d.researchers.toLocaleString()}<br/>Top venues: ${venues || '—'}`);
          })
          .on('mouseout', () => tip.style('display','none'));
      }
    }

    function downloadInlineMapPNG() {
      const wrapper = document.getElementById('map-wrapper');
      const svg = wrapper.querySelector('svg');
      if (!svg) return;
      const serializer = new XMLSerializer();
      let source = serializer.serializeToString(svg);
      if (!source.match(/^<svg[^>]+xmlns=/)) source = source.replace('<svg','<svg xmlns="http://www.w3.org/2000/svg"');
      const blob = new Blob([source], {type:'image/svg+xml;charset=utf-8'});
      const url = URL.createObjectURL(blob);
      const img = new Image();
      const scale = 2;
      img.onload = function(){
        const canvas = document.createElement('canvas');
        const vb = svg.viewBox.baseVal; canvas.width=(vb.width||svg.clientWidth)*scale; canvas.height=(vb.height||svg.clientHeight)*scale;
        const ctx = canvas.getContext('2d'); ctx.fillStyle='#ffffff'; ctx.fillRect(0,0,canvas.width,canvas.height); ctx.drawImage(img,0,0,canvas.width,canvas.height); URL.revokeObjectURL(url);
        const png = canvas.toDataURL('image/png'); const a=document.createElement('a'); a.href=png; a.download='papers_map.png'; document.body.appendChild(a); a.click(); document.body.removeChild(a);
      };
      img.src = url;
    }
  </script>
</body>
</html>


